import{i as bt,k as T,r as Rt,u as Ft}from"./chunk-LGCLU4JF.js";import{a as $,b as V,c as rt,e as tt,f as Dt,g as b,h as W,i as L,j as ot,k as z,l as M,m as H,n as et,o as _,p as Et,q as nt,r as xt,s as Nt}from"./chunk-BS6XHXOG.js";import{f as Mt}from"./chunk-42ONX6RL.js";import{b as pt}from"./chunk-MQGUF25V.js";import"./chunk-QR7PKRAV.js";import{k as gt}from"./chunk-WHNYGZCR.js";import{b as c,c as J,d as Q,e as X,g as Z}from"./chunk-YJ5RMHHJ.js";function Bt(e){return e*e*e*(10-e*(15-6*e))}var Ct=new xt,Ht=new M({color:new z(6710886).convertLinearToSRGB()}),jt=new M({color:new z(13421772).convertLinearToSRGB(),side:V,transparent:!0,opacity:.75}),ht=new M({visible:!1}),Vt=new M({color:4513228}),Wt=new M({color:16776618}),_t=new M({color:4513228,side:V,transparent:!0,opacity:.5}),qt=new M({color:16775545,side:V,transparent:!0,opacity:.5}),K=class{constructor(e,t,s,i,r,o){c(this,"stickerMaterial");c(this,"hintStickerMaterial");this.vector=e,this.fromZ=t,this.color=s,this.dimColor=i,this.hintOpacityScale=r;let a=new z(s).convertLinearToSRGB(),n=new z(i).convertLinearToSRGB();this.stickerMaterial={regular:new M({color:a,side:$}),dim:new M({color:n,side:$}),oriented:Vt,experimentalOriented2:Wt,ignored:Ht,invisible:ht},this.hintStickerMaterial={regular:new M({color:new z(o?.hintColor??s).convertLinearToSRGB(),side:V,transparent:!0,opacity:.5*r}),dim:new M({color:new z(o?.hintDimColor??i).convertLinearToSRGB(),side:V,transparent:!0,opacity:.5*r}),oriented:_t,experimentalOriented2:qt,ignored:jt,invisible:ht}}},O=[new K(new b(0,1,0),new L(-T/4,0,0),16777215,14540253,1.25),new K(new b(-1,0,0),new L(0,-T/4,0),16750848,8934656,1,{hintDimColor:8930304}),new K(new b(0,0,1),new L(0,0,0),65280,34816,1,{hintDimColor:39168}),new K(new b(1,0,0),new L(0,T/4,0),16711680,6684672,1,{hintDimColor:6684672}),new K(new b(0,0,-1),new L(0,T/2,0),2254591,1127304,.75,{hintDimColor:6246}),new K(new b(0,-1,0),new L(T/4,0,0),16776960,8947712,1.25,{hintDimColor:14540032})],k={U:0,L:1,F:2,R:3,B:4,D:5},Jt={U:k.U,u:k.U,Uw:k.U,Uv:k.U,y:k.U,L:k.L,l:k.L,Lw:k.L,Lv:k.L,M:k.L,F:k.F,f:k.F,Fw:k.F,Fv:k.F,S:k.F,z:k.F,R:k.R,r:k.R,Rw:k.R,Rv:k.R,x:k.R,B:k.B,b:k.B,Bw:k.B,Bv:k.B,D:k.D,d:k.D,Dw:k.D,Dv:k.D,E:k.D},q={stickerElevation:.503,foundationWidth:1,hintStickerElevation:1.45},Qt=2,Xt={showMainStickers:!0,hintFacelets:"floating",showFoundation:!0,experimentalStickeringMask:void 0,foundationSprite:null,hintSprite:null,initialHintFaceletsAnimation:"auto",faceletScale:"auto"},Zt=.85;function mt(e){return typeof e.faceletScale>"u"||e.faceletScale==="auto"?Zt:e.faceletScale}var $t=new M({color:0,opacity:1,transparent:!0}),Kt=new M({color:0,opacity:.3,transparent:!0}),y=class{constructor(e,t,s){c(this,"matrix");c(this,"stickerFaces");this.orbit=e;let i=typeof t=="string"?t.split(""):t;this.stickerFaces=i.map(r=>k[r]),this.matrix=new W,this.matrix.setPosition(ct[e]),this.matrix.premultiply(new W().makeRotationFromQuaternion(s))}};function h(e,t){return new Dt().setFromAxisAngle(e,T*t/4)}var u={O:new b(0,0,0),U:new b(0,-1,0),L:new b(1,0,0),F:new b(0,0,-1),R:new b(-1,0,0),B:new b(0,0,1),D:new b(0,1,0)},ct={EDGES:new b(0,1,1),CORNERS:new b(1,1,1),CENTERS:new b(0,1,0)},Yt={EDGES:[0,1].map(e=>new W().makeRotationAxis(ct.EDGES.clone().normalize(),-e*T/2)),CORNERS:[0,1,2].map(e=>new W().makeRotationAxis(ct.CORNERS.clone().normalize(),-e*T/3)),CENTERS:[0,1,2,3].map(e=>new W().makeRotationAxis(ct.CENTERS.clone().normalize(),-e*T/4))},kt=[k.U,k.F,k.R],it={EDGES:[new y("EDGES","UF",h(u.O,0)),new y("EDGES","UR",h(u.U,3)),new y("EDGES","UB",h(u.U,2)),new y("EDGES","UL",h(u.U,1)),new y("EDGES","DF",h(u.F,2)),new y("EDGES","DR",h(u.F,2).premultiply(h(u.D,1))),new y("EDGES","DB",h(u.F,2).premultiply(h(u.D,2))),new y("EDGES","DL",h(u.F,2).premultiply(h(u.D,3))),new y("EDGES","FR",h(u.U,3).premultiply(h(u.R,3))),new y("EDGES","FL",h(u.U,1).premultiply(h(u.R,3))),new y("EDGES","BR",h(u.U,3).premultiply(h(u.R,1))),new y("EDGES","BL",h(u.U,1).premultiply(h(u.R,1)))],CORNERS:[new y("CORNERS","UFR",h(u.O,0)),new y("CORNERS","URB",h(u.U,3)),new y("CORNERS","UBL",h(u.U,2)),new y("CORNERS","ULF",h(u.U,1)),new y("CORNERS","DRF",h(u.F,2).premultiply(h(u.D,1))),new y("CORNERS","DFL",h(u.F,2).premultiply(h(u.D,0))),new y("CORNERS","DLB",h(u.F,2).premultiply(h(u.D,3))),new y("CORNERS","DBR",h(u.F,2).premultiply(h(u.D,2)))],CENTERS:[new y("CENTERS","U",h(u.O,0)),new y("CENTERS","L",h(u.R,3).premultiply(h(u.U,1))),new y("CENTERS","F",h(u.R,3)),new y("CENTERS","R",h(u.R,3).premultiply(h(u.D,1))),new y("CENTERS","B",h(u.R,3).premultiply(h(u.D,2))),new y("CENTERS","D",h(u.R,2))]},St=1/3,at={EDGES:[[[0,4,6],[0,4,5]],[[3,5,7],[0,7,5]],[[2,4,8],[0,10,5]],[[1,3,7],[0,1,5]],[[2,4,2],[2,4,3]],[[3,5,1],[2,7,3]],[[0,4,0],[2,10,3]],[[1,3,1],[2,1,3]],[[3,5,4],[3,6,4]],[[1,3,4],[1,2,4]],[[1,9,4],[1,8,4]],[[3,11,4],[3,0,4]]],CORNERS:[[[0,5,6],[0,5,5],[0,6,5]],[[3,5,8],[0,8,5],[0,9,5]],[[2,3,8],[0,11,5],[0,0,5]],[[1,3,6],[0,2,5],[0,3,5]],[[3,5,2],[2,6,3],[2,5,3]],[[2,3,2],[2,3,3],[2,2,3]],[[1,3,0],[2,0,3],[2,11,3]],[[0,5,0],[2,9,3],[2,8,3]]],CENTERS:[[[0,4,7]],[[0,1,4]],[[0,4,4]],[[0,7,4]],[[0,10,4]],[[0,4,1]]]},Tt=null;function te(){return Tt??(Tt=new Et(q.foundationWidth,q.foundationWidth,q.foundationWidth))}function vt(){let e=new et,t=.5;return e.setAttribute("position",new H(new Float32Array([t,t,0,-t,t,0,t,-t,0,-t,t,0,-t,-t,0,t,-t,0]),3)),e.setAttribute("uv",new H(new Float32Array([1,1,0,1,1,0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,1,1]),2)),e}var At=null;function ee(){return At??(At=vt())}var ut,Y,lt,ft,Lt,Gt,ie=(Gt=class extends ot{constructor(t,s,i={}){super();Q(this,Y);Q(this,ft);c(this,"kpuzzleFaceletInfo");c(this,"pieces",{});c(this,"options");c(this,"experimentalHintStickerMeshes",[]);c(this,"experimentalFoundationMeshes",[]);c(this,"setSpriteURL");c(this,"sprite",new Promise(t=>{this.setSpriteURL=s=>{Ct.load(s,t)}}));c(this,"setHintSpriteURL");c(this,"hintSprite",new Promise(t=>{this.setHintSpriteURL=s=>{Ct.load(s,t)}}));Q(this,ut,null);if(this.kpuzzle=t,this.scheduleRenderCallback=s,this.options={...Xt},Object.assign(this.options,i),this.kpuzzle.name()!=="3x3x3")throw new Error(`Invalid puzzle for this Cube3D implementation: ${this.kpuzzle.name()}`);i.foundationSprite&&this.setSprite(i.foundationSprite),i.hintSprite&&this.setHintSprite(i.hintSprite),this.kpuzzleFaceletInfo={};for(let r in it){let o=[];this.kpuzzleFaceletInfo[r]=o,this.pieces[r]=it[r].map(this.createCubie.bind(this,r,o))}this.scale.set(St,St,St),this.options.experimentalStickeringMask&&this.setStickeringMask(this.options.experimentalStickeringMask),Z(this,ft,Lt).call(this),this.options.faceletScale&&this.experimentalSetFaceletScale(this.options.faceletScale)}setSprite(t){this.sprite=t}setHintSprite(t){this.hintSprite=t}experimentalSetStickerSpriteURL(t){this.setSpriteURL(t)}experimentalSetHintStickerSpriteURL(t){this.setHintSpriteURL(t)}setStickeringMask(t){if(t.specialBehaviour==="picture"){for(let s of Object.values(this.kpuzzleFaceletInfo))for(let i of s)for(let r of i){r.facelet.material=ht;let{hintFacelet:o}=r;o&&(o.material=ht)}return}this.options.experimentalStickeringMask=t;for(let[s,i]of Object.entries(t.orbits))for(let r=0;r<i.pieces.length;r++){let o=i.pieces[r];if(o){let a=this.kpuzzleFaceletInfo[s][r];for(let n=0;n<a.length;n++){let d=o.facelets[n];if(d){let p=a[n],m=typeof d=="string"?d:d?.mask;p.facelet.material=O[p.faceIdx].stickerMaterial[m];let D=typeof d=="string"?m:d.hintMask??m;p.hintFacelet&&(p.hintFacelet.material=O[p.faceIdx].hintStickerMaterial[D])}}}}this.scheduleRenderCallback&&this.scheduleRenderCallback()}experimentalUpdateOptions(t){if("showMainStickers"in t)throw new Error("Unimplemented");let s=t.showFoundation;if(typeof s<"u"&&this.options.showFoundation!==s){this.options.showFoundation=s;for(let a of this.experimentalFoundationMeshes)a.visible=s}let i=t.hintFacelets;if(typeof i<"u"&&this.options.hintFacelets!==i&&bt[i]){this.options.hintFacelets=i;for(let a of this.experimentalHintStickerMeshes)a.visible=i==="floating";this.scheduleRenderCallback()}let{experimentalStickeringMask:r}=t;typeof r<"u"&&(this.options.experimentalStickeringMask=r,this.setStickeringMask(r),this.scheduleRenderCallback());let{faceletScale:o}=t;typeof o<"u"&&this.experimentalSetFaceletScale(o)}onPositionChange(t){let s=t.pattern;for(let i in it){let r=it[i];for(let o=0;o<r.length;o++){let a=s.patternData[i].pieces[o];this.pieces[i][a].matrix.copy(it[i][o].matrix),this.pieces[i][a].matrix.multiply(Yt[i][s.patternData[i].orientation[o]])}for(let o of t.movesInProgress){let a=o.move,n=O[Jt[a.family]].vector,d=new W().makeRotationAxis(n,-this.ease(o.fraction)*o.direction*a.amount*T/4);for(let p=0;p<r.length;p++){let m=this.kpuzzle.moveToTransformation(a.modified({amount:1})),D=m.transformationData[i].permutation[p];if(p!==D||m.transformationData[i].orientationDelta[p]!==0){let w=s.patternData[i].pieces[p];this.pieces[i][w].matrix.premultiply(d)}}}}this.scheduleRenderCallback()}createCubie(t,s,i,r){let o=[];s.push(o);let a=new nt;if(this.options.showFoundation){let n=this.createCubieFoundation();a.add(n),this.experimentalFoundationMeshes.push(n)}for(let n=0;n<i.stickerFaces.length;n++){let d=this.createSticker(O[kt[n]],O[i.stickerFaces[n]],!1),p={faceIdx:i.stickerFaces[n],facelet:d};if(a.add(d),this.options.hintFacelets==="floating"){let m=this.createSticker(O[kt[n]],O[i.stickerFaces[n]],!0);a.add(m),p.hintFacelet=m,this.experimentalHintStickerMeshes.push(m)}if(this.options.experimentalStickeringMask?.specialBehaviour==="picture"&&at[t]&&at[t][r]&&at[t][r][n]){let[m,D,w]=at[t][r][n];(async()=>{let v=async f=>{let B=await(f?this.hintSprite:this.sprite),R=this.createSticker(O[kt[n]],O[i.stickerFaces[n]],f);R.material=new M({map:B,side:f?V:rt,transparent:!0});let U=D/12,G=(D+1)/12,I=w/9,C=(w+1)/9,F=new tt(U,I),E=new tt(U,C),g=new tt(G,C),l=new tt(G,I);switch(m){case 1:{[F,E,g,l]=[E,g,l,F];break}case 2:{[F,E,g,l]=[g,l,F,E];break}case 3:{[F,E,g,l]=[l,F,E,g];break}}R.geometry.setAttribute("uv",new H(new Float32Array([g.x,g.y,E.x,E.y,l.x,l.y,E.x,E.y,F.x,F.y,l.x,l.y]),2)),a.add(R)};v(!0),v(!1)})()}o.push(p)}return a.matrix.copy(i.matrix),a.matrixAutoUpdate=!1,this.add(a),a}createCubieFoundation(){let t=te();return new _(t,this.options.experimentalStickeringMask?.specialBehaviour==="picture"?$t:Kt)}createSticker(t,s,i){let r=this.options.experimentalStickeringMask?.specialBehaviour==="picture"?vt():i?Z(this,Y,lt).call(this):ee(),o=new _(r,i?s.hintStickerMaterial.regular:s.stickerMaterial.regular);return o.setRotationFromEuler(t.fromZ),o.position.copy(t.vector),o.position.multiplyScalar(i?this.options.experimentalStickeringMask?.specialBehaviour==="picture"?Qt:q.hintStickerElevation:q.stickerElevation),o.scale.setScalar(mt(this.options)),o}experimentalSetFoundationOpacity(t){this.experimentalFoundationMeshes[0].material.opacity=t}experimentalSetFaceletScale(t){this.options.faceletScale=t;for(let s of Object.values(this.kpuzzleFaceletInfo))for(let i of s)for(let r of i)r.facelet.scale.setScalar(mt(this.options)),r.hintFacelet?.scale.setScalar(mt(this.options))}ease(t){return Bt(t)}},ut=new WeakMap,Y=new WeakSet,lt=function(){return J(this,ut)??X(this,ut,vt())},ft=new WeakSet,Lt=function(){if(this.options.initialHintFaceletsAnimation==="none"||this.options.initialHintFaceletsAnimation!=="always"&&Ft())return;let t=q.hintStickerElevation-q.stickerElevation;Z(this,Y,lt).call(this).translate(0,0,-t),setTimeout(()=>{let s=performance.now(),i=0,r=1e3;function o(n){return n*(2-n)}let a=()=>{let n=performance.now()-s,d=o(n/r)*t;Z(this,Y,lt).call(this).translate(0,0,d-i),i=d,n<r&&(requestAnimationFrame(a),this.scheduleRenderCallback?.())};a()},500)},Gt),Ut=new M({side:rt,color:0}),j=new M({visible:!1}),st=new M({vertexColors:!0});function wt(e,t,s){return Math.hypot(e[3*t]-e[3*s],e[3*t+1]-e[3*s+1],e[3*t+2]-e[3*s+2])}function se(e,t,s,i){let r=wt(e,t,s),o=wt(e,s,i),a=wt(e,t,i),n=(r+o+a)/2;return Math.sqrt(n*(n-r)*(n-o)*(n-a))}function re(e){let t=0;for(let s=2;3*s<e.length;s++)t+=se(e,0,1,s);return t}function oe(e){let t=Math.hypot(e[0],e[1],e[2]);return e[0]/=t,e[1]/=t,e[2]/=t,e}function ne(e,t){let s=new Array(3);return s[0]=e[1]*t[2]-e[2]*t[1],s[1]=e[2]*t[0]-e[0]*t[2],s[2]=e[0]*t[1]-e[1]*t[0],s}function ae(e){let t=[e[3]-e[0],e[4]-e[1],e[5]-e[2]],s=[e[6]-e[3],e[7]-e[4],e[8]-e[5]],i=ne(t,s);return oe(i)}function ce(e,t){let s=[],i=new Array(3),r=new Array(3);for(let o=1;o<10;o++){for(let n=0;n<e.length;n+=3){let d=(n+e.length-3)%e.length,p=(n+3)%e.length;for(let f=0;f<3;f++)i[f]=e[d+f]-e[n+f],r[f]=e[p+f]-e[n+f];let m=Math.hypot(i[0],i[1],i[2]),D=Math.hypot(r[0],r[1],r[2]);for(let f=0;f<3;f++)i[f]/=m,r[f]/=D;let w=i[0]*r[0]+i[1]*r[1]+i[2]*r[2],v=t/Math.sqrt(1-w*w);for(let f=0;f<3;f++)s[n+f]=e[n+f]+(i[f]+r[f])*v}let a=!0;for(let n=0;a&&n<s.length;n+=3){let d=(n+3)%e.length,p=0;for(let m=0;m<3;m++){let D=e[d+m]-e[n+m],w=s[d+m]-s[n+m];p+=D*w}p<=0&&(a=!1)}if(a)return s;t/=2}return e}var Ot=class{constructor(e,t){c(this,"pos");c(this,"ipos");c(this,"vertices");c(this,"colors");c(this,"uvs");c(this,"ind");this.sz=e,this.tm=t,this.vertices=new Float32Array(9*e),this.uvs=void 0,this.colors=new Uint8Array(18*e),this.ind=new Uint8Array(e),this.pos=0,this.ipos=0}add(e,t,s){this.vertices[this.pos]=e[3*t+0],this.vertices[this.pos+1]=e[3*t+1],this.vertices[this.pos+2]=e[3*t+2],this.colors[this.pos]=s>>16,this.colors[this.pos+1]=s>>8&255,this.colors[this.pos+2]=s&255,this.pos+=3}addUncolored(e,t){this.vertices[this.pos]=e[3*t+0],this.vertices[this.pos+1]=e[3*t+1],this.vertices[this.pos+2]=e[3*t+2],this.pos+=3}setind(e){this.ind[this.ipos++]=e}makePoly(e,t,s){let i=e;for(let r=1;3*(r+1)<i.length;r++)this.add(i,0,t),this.add(i,r,t),this.add(i,r+1,t),this.setind(s)}setAttributes(e){e.setAttribute("position",new H(this.vertices,3));let t=this.colors.subarray(0,9*this.sz);e.setAttribute("color",new H(t,3,!0))}makeGroups(e){e.clearGroups();for(let t=0;t<this.ipos;){let s=t++,i=this.ind[s];for(;this.ind[t]===i;)t++;e.addGroup(3*s,3*(t-s),i)}}saveOriginalColors(){this.colors.copyWithin(this.pos,0,this.pos)}},le=class{constructor(e,t,s,i){c(this,"origColor");c(this,"origColorStickeringMask");c(this,"faceColor");c(this,"texturePtr");c(this,"twistVal",-1);c(this,"stickerStart");c(this,"stickerEnd");c(this,"hintStart");c(this,"hintEnd");c(this,"foundationStart");c(this,"foundationEnd");c(this,"isDup");c(this,"faceNum");this.isDup=!!t.isDup,this.faceNum=t.face,this.stickerStart=e.ipos;let r=new z(t.color).getHex();this.origColor=r,this.origColorStickeringMask=r,i?.stickeringMask&&this.setStickeringMask(e,i.stickeringMask),this.faceColor=r;let o=this.stickerCoords(t.coords,s);e.makePoly(o,this.faceColor,this.isDup?4:0),this.stickerEnd=e.ipos}stickerCoords(e,t){return ce(e.slice(),t)}hintCoords(e,t,s,i){e=this.stickerCoords(e,s),i=i.slice();for(let o=0;o<3;o++)i[o]*=.5*t;let r=new Array(e.length);for(let o=0;3*o<e.length;o++){let a=e.length/3-1-o;r[3*o]=e[3*a]+i[0],r[3*o+1]=e[3*a+1]+i[1],r[3*o+2]=e[3*a+2]+i[2]}return r}foundationCoords(e){let t=e.slice();for(let s=0;s<e.length;s++)t[s]=e[s]*.999;return t}addHint(e,t,s,i,r,o){this.hintStart=e.ipos;let a=this.hintCoords(t.coords,i,r,o);e.makePoly(a,this.faceColor,s&&!this.isDup?2:4),this.hintEnd=e.ipos}addFoundation(e,t,s){this.foundationStart=e.ipos;let i=this.foundationCoords(t.coords);e.makePoly(i,s,this.isDup?4:6),this.foundationEnd=e.ipos}setHintStickers(e,t){let s=this.isDup||!t?4:2;for(let i=this.hintStart;i<this.hintEnd;i++)e.ind[i]=s|e.ind[i]&1}setStickeringMask(e,t){let s=0;switch(t){case"regular":{s=this.origColor;break}case"dim":{this.origColor===16777215?s=14540253:s=new z(this.origColor).multiplyScalar(.5).getHex();break}case"oriented":{s=16746751;break}case"ignored":{s=4473924;break}case"invisible":s=this.origColor}this.origColorStickeringMask=s;for(let i=9*this.stickerStart;i<9*this.stickerEnd;i+=3)e.colors[e.pos+i]=s>>16,e.colors[e.pos+i+1]=s>>8&255,e.colors[e.pos+i+2]=s&255;for(let i=9*this.hintStart;i<9*this.hintEnd;i+=3)e.colors[e.pos+i]=s>>16,e.colors[e.pos+i+1]=s>>8&255,e.colors[e.pos+i+2]=s&255;this.setHintStickers(e,t!=="invisible"&&!this.isDup)}addUVs(e){let t=e.uvs,s=e.vertices,i=new Array(3);for(let r=3*this.stickerStart;r<3*this.stickerEnd;r++){i[0]=s[3*r],i[1]=s[3*r+1],i[2]=s[3*r+2];let o=e.tm.getuv(this.faceNum,i);t[2*r]=o[0],t[2*r+1]=o[1]}for(let r=3*this.hintStart;r<3*this.hintEnd;r++){i[0]=s[3*r],i[1]=s[3*r+1],i[2]=s[3*r+2];let o=e.tm.getuv(this.faceNum,i);t[2*r]=o[0],t[2*r+1]=o[1]}}setTexture(e,t){if(this.texturePtr===t)return 0;this.texturePtr=t;let s=6*e.sz;return e.uvs.copyWithin(6*this.stickerStart,6*t.stickerStart+s,6*t.stickerEnd+s),e.uvs.copyWithin(6*this.hintStart,6*t.hintStart+s,6*t.hintEnd+s),1}setColor(e,t){let s=t.origColorStickeringMask;if(this.faceColor!==s){this.faceColor=s;let i=e.pos;return e.colors.copyWithin(9*this.stickerStart,9*t.stickerStart+i,9*t.stickerEnd+i),e.colors.copyWithin(9*this.hintStart,9*t.hintStart+i,9*t.hintEnd+i),1}else return 0}},he=class{constructor(e,t,s){c(this,"cubie");c(this,"geo");this.cubie=new nt;let i=e.coords,r=new Ot(i.length/3-2,t);for(let a=1;3*a+3<i.length;a++)r.addUncolored(i,0),r.addUncolored(i,a),r.addUncolored(i,a+1);this.geo=new et,r.setAttributes(this.geo);let o=new _(this.geo,j);o.userData.quantumMove=s.notationMapper.notationToExternal(new gt(e.name)),this.cubie.scale.setScalar(.99),this.cubie.add(o)}},ue=class{constructor(e){c(this,"axis");c(this,"order");let t=e.coordinates;this.axis=new b(t[0],t[1],t[2]),this.order=e.order}},fe=.71,P=.5,A,dt,Pt,zt,de=(zt=class extends ot{constructor(t,s,i,r=!1,o=!1,a=1,n=1,d={}){super();Q(this,dt);c(this,"stickers");c(this,"axesInfo");c(this,"stickerTargets",[]);c(this,"controlTargets",[]);c(this,"movingObj");c(this,"filler");c(this,"foundationBound");c(this,"fixedGeo");c(this,"lastPos");c(this,"lastMoveTransformation");c(this,"hintMaterial");c(this,"stickerMaterial");c(this,"materialArray1");c(this,"materialArray2");c(this,"textured",!1);c(this,"showHintStickers",!1);c(this,"showFoundations",!1);c(this,"hintMaterialDisposable");c(this,"stickerMaterialDisposable");Q(this,A,!1);c(this,"isPG3DForTwisty3DPuzzleWrapper");if(this.scheduleRenderCallback=t,this.kpuzzle=s,this.stickerDat=i,this.faceletScale=n,this.params=d,i.stickers.length===0)throw Error("Reuse of stickerdat from pg; please don't do that.");this.hintMaterial=new M({vertexColors:!0,transparent:!0,opacity:.5}),this.hintMaterialDisposable=!0,this.stickerMaterial=st,this.stickerMaterialDisposable=!1,this.axesInfo={};let p=this.stickerDat.axis;for(let l of p)this.axesInfo[l.quantumMove.family]=new ue(l);let m=this.stickerDat.stickers;this.stickers={},this.materialArray1=new Array(8),this.materialArray2=new Array(8),this.showFoundation(r),r=!0;let D=0,w=3;for(let l of m){let x=l.coords.length/3;D+=w*(x-2)}let v=new Ot(D,i.textureMapper),f=0,B=[],R=0;for(let l of i.faces)B.push(ae(l.coords)),R+=re(l.coords);let U=n!=="auto"?n*n:fe,G=0;for(let l of m)l.isDup||G++;let I=Math.sqrt(R/G)*(1-Math.sqrt(U))/2;for(let l of m){let x=l.orbit,S=l.ord,N=l.ori;this.stickers[x]||(this.stickers[x]=[]),this.stickers[x][N]||(this.stickers[x][N]=[]);let yt={};d.stickeringMask&&(yt.stickeringMask=pt(d.stickeringMask,x,S,N,!1));let It=new le(v,l,I,yt);this.stickers[x][N][S]=It}this.showHintStickers=o,o=!0;for(let l of m){let x=l.orbit,S=l.ord,N=l.ori;this.stickers[x][N][S].addHint(v,l,o,a,I,B[l.face])}this.foundationBound=v.ipos;for(let l of m){let x=l.orbit,S=l.ord,N=l.ori;r&&this.stickers[x][N][S].addFoundation(v,l,f)}let C=new et;v.setAttributes(C),v.makeGroups(C);let F=new _(C,this.materialArray1);F.scale.set(P,P,P),this.add(F);let E=new _(C,this.materialArray2);E.scale.set(P,P,P),this.add(E);let g=this.stickerDat.faces;this.movingObj=E,this.fixedGeo=C,this.filler=v;for(let l of g){let x=new he(l,i.textureMapper,this.stickerDat);x.cubie.scale.set(P,P,P),this.add(x.cubie),this.controlTargets.push(x.cubie.children[0])}v.saveOriginalColors(),i.stickers=[],this.updateMaterialArrays()}dispose(){this.fixedGeo&&this.fixedGeo.dispose(),this.stickerMaterialDisposable&&(this.stickerMaterial.dispose(),this.stickerMaterial=st,this.stickerMaterialDisposable=!1),this.hintMaterialDisposable&&(this.hintMaterial.dispose(),this.hintMaterial=st,this.hintMaterialDisposable=!1)}experimentalGetStickerTargets(){return this.stickerTargets}experimentalGetControlTargets(){return this.controlTargets}getClosestMoveToAxis(t,s){let i=null,r=0,o=n=>n;switch(s.depth){case"secondSlice":{o=n=>n.modified({innerLayer:2});break}case"rotation":{o=n=>n.modified({family:`${n.family}v`});break}}for(let n of this.stickerDat.axis){let d=t.dot(new b(...n.coordinates));if(d>r){let p=this.stickerDat.notationMapper.notationToExternal(o(n.quantumMove));if(!p)continue;Z(this,dt,Pt).call(this,p)&&(r=d,i=p)}}if(!i)return null;s.invert&&(i=i.invert());let a=this.kpuzzle.moveToTransformation(i).repetitionOrder();return{move:i,order:a}}setStickeringMask(t){if(this.params.stickeringMask=t,t.specialBehaviour!=="picture")for(let s of this.kpuzzle.definition.orbits){let{numPieces:i,numOrientations:r}=s;for(let o=0;o<i;o++)for(let a=0;a<r;a++){let n=pt(t,s.orbitName,o,a,!1),d=this.stickers[s.orbitName][a][o];this.textured&&this.hintMaterialDisposable&&n==="invisible"||d.setStickeringMask(this.filler,n)}}X(this,A,!0),this.lastPos&&this.onPositionChange(this.lastPos)}onPositionChange(t){let s=t.pattern.experimentalToTransformation();if(!s)throw new Error("indistinguishable pieces are not supported by PG3D yet");let i=new L;this.movingObj.rotation.copy(i);let r=0,o=this.filler,a=o.ind;if(!this.lastPos||J(this,A)||!this.lastPos.pattern.experimentalToTransformation().isIdentical(s)){for(let d in this.stickers){let p=this.stickers[d],m=s.transformationData[d],D=p.length;if(D===1){let w=p[0];for(let v=0;v<w.length;v++){let f=m.permutation[v];this.textured?r+=w[v].setTexture(o,w[f]):r+=w[v].setColor(o,w[f])}}else for(let w=0;w<D;w++){let v=p[w];for(let f=0;f<v.length;f++){let B=(w+D-m.orientationDelta[f])%D,R=m.permutation[f];this.textured?r+=v[f].setTexture(o,p[B][R]):r+=v[f].setColor(o,p[B][R])}}}this.lastPos=t}let n=0;for(let d of t.movesInProgress){let p=d.move,m=this.stickerDat.unswizzle(p);if(!m)return;let D=p,w;try{w=this.kpuzzle.moveToTransformation(D.modified({amount:1}))}catch(R){let U=this.stickerDat.notationMapper.notationToInternal(D);if(U){let G=this.stickerDat.notationMapper.notationToExternal(U.modified({amount:1}));G&&(w=this.kpuzzle.moveToTransformation(G))}if(!w)throw console.log(R),R}let v=this.axesInfo[m.family],f=v.axis,B=-this.ease(d.fraction)*d.direction*m.amount*T/v.order;if(this.movingObj.rotateOnAxis(f,B),this.lastMoveTransformation!==w){for(let R in this.stickers){let U=this.stickers[R],G=U.length,I=w.transformationData[R];for(let C=0;C<G;C++){let F=U[C];for(let E=0;E<F.length;E++){let g=F[E],l=I.permutation[E],x=0;if((l!==E||I.orientationDelta[E]!==0)&&(x=1),x!==g.twistVal){if(x){for(let S=g.stickerStart;S<g.stickerEnd;S++)a[S]|=1;for(let S=g.hintStart;S<g.hintEnd;S++)a[S]|=1;for(let S=g.foundationStart;S<g.foundationEnd;S++)a[S]|=1}else{for(let S=g.stickerStart;S<g.stickerEnd;S++)a[S]&=-2;for(let S=g.hintStart;S<g.hintEnd;S++)a[S]&=-2;for(let S=g.foundationStart;S<g.foundationEnd;S++)a[S]&=-2}g.twistVal=x,n++}}}}this.lastMoveTransformation=w}}(J(this,A)||n)&&this.filler.makeGroups(this.fixedGeo),(J(this,A)||r)&&(this.textured&&(this.fixedGeo.getAttribute("uv").addUpdateRange(0,6*this.foundationBound),this.fixedGeo.getAttribute("uv").needsUpdate=!0),(J(this,A)||!this.textured)&&(this.fixedGeo.getAttribute("color").addUpdateRange(0,9*this.foundationBound),this.fixedGeo.getAttribute("color").needsUpdate=!0)),this.scheduleRenderCallback(),X(this,A,!1)}ease(t){return Bt(t)}showHintFacelets(t){this.showHintStickers=t}updateMaterialArrays(){for(let t=0;t<8;t++)this.materialArray1[t]=j,this.materialArray2[t]=j;this.materialArray1[0]=this.stickerMaterial,this.materialArray2[1]=this.stickerMaterial,this.showHintStickers?(this.materialArray1[2]=this.hintMaterial,this.materialArray2[3]=this.hintMaterial):(this.materialArray1[2]=j,this.materialArray2[3]=j),this.showFoundations?(this.materialArray1[6]=Ut,this.materialArray2[7]=Ut):(this.materialArray1[6]=j,this.materialArray2[7]=j)}showFoundation(t){this.showFoundations=t}setHintStickerOpacity(t){this.hintMaterialDisposable&&(this.hintMaterial.dispose(),this.hintMaterialDisposable=!1),t===0?this.hintMaterial=j:t===1?this.hintMaterial=this.stickerMaterial:(this.hintMaterial=new M({vertexColors:!0,transparent:!0,opacity:t}),this.hintMaterialDisposable=!0)}experimentalUpdateOptions(t){t.hintFacelets!==void 0&&this.showHintFacelets(t.hintFacelets!=="none"),t.showFoundation!==void 0&&this.showFoundation(t.showFoundation),t.hintStickerOpacity!==void 0&&this.setHintStickerOpacity(t.hintStickerOpacity),X(this,A,!0),this.lastPos&&this.onPositionChange(this.lastPos),typeof t.faceletScale<"u"&&t.faceletScale!==this.faceletScale&&console.warn("Dynamic facelet scale is not yet supported for PG3D. For now, re-create the TwistyPlayer to change the facelet scale."),this.updateMaterialArrays(),this.scheduleRenderCallback()}adduvs(){let t=this.filler;if(t.uvs)return;this.filler.uvs=new Float32Array(12*t.sz);for(let i in this.stickers){let r=this.stickers[i],o=r.length;for(let a=0;a<o;a++){let n=r[a];for(let d of n)d.addUVs(this.filler)}}t.uvs.copyWithin(6*t.sz,0,6*t.sz);let s=t.uvs.subarray(0,6*t.sz);this.fixedGeo.setAttribute("uv",new H(s,2,!0))}experimentalUpdateTexture(t,s,i){s||(t=!1),t&&!this.filler.uvs&&this.adduvs(),this.textured=t,this.stickerMaterialDisposable&&(this.stickerMaterial.dispose(),this.stickerMaterialDisposable=!1),t?(this.stickerMaterial=new M({map:s,side:$,transparent:!1}),this.stickerMaterialDisposable=!0):this.stickerMaterial=st,this.hintMaterialDisposable&&(this.hintMaterial.dispose(),this.hintMaterialDisposable=!1),t?(this.hintMaterial=new M({map:i,side:$,transparent:!0}),this.hintMaterialDisposable=!0):this.hintMaterial=st,t&&this.showHintFacelets(i!==null),this.updateMaterialArrays(),X(this,A,!0),this.lastPos&&this.onPositionChange(this.lastPos),this.scheduleRenderCallback()}},A=new WeakMap,dt=new WeakSet,Pt=function(t){try{return this.kpuzzle.moveToTransformation(t),!0}catch{return!1}},zt),ge=class{constructor(){c(this,"renderTargets",new Set);c(this,"twisty3Ds",new Set);c(this,"threeJSScene",(async()=>new(await Rt).Scene)())}addRenderTarget(e){this.renderTargets.add(e)}scheduleRender(){for(let e of this.renderTargets)e.scheduleRender()}async addTwisty3DPuzzle(e){this.twisty3Ds.add(e),(await this.threeJSScene).add(e)}async removeTwisty3DPuzzle(e){this.twisty3Ds.delete(e),(await this.threeJSScene).remove(e)}async clearPuzzles(){for(let e of this.twisty3Ds)(await this.threeJSScene).remove(e);this.twisty3Ds.clear()}};async function Me(e,t){return new ie(await Mt.kpuzzle(),e,t)}async function De(e,t,s,i,r){return new de(e,await t.kpuzzle(),(await t.pg()).get3d({darkIgnoredOrbits:r}),!0,s==="floating",void 0,i)}export{ie as Cube3D,de as PG3D,Nt as T3I,ge as Twisty3DScene,Me as cube3DShim,De as pg3dShim};
